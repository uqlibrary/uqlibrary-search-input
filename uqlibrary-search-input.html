<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-selector/iron-selector.html">

<!--

Reusable search input

##### Example

<uqlibrary-search-input></uqlibrary-search-input>

@element uqlibrary-search-input
@blurb Reusable search input
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-search-input
-->

<dom-module id="uqlibrary-search-input">
  <style>
    paper-input {
      background: rgba(255,255,255,.15);
      border-radius: 2px;
    }
    paper-input:hover, paper-input:focus {
      background: rgba(255,255,255,.25);
    }
    .paper-input-container-0 .input-content.paper-input-container input {
      color: white;
    }
    .hidden {
      transform: translateY(-200%);
      /*visibility: hidden;*/
      transition: transform .2s,visibility .2s;
    }
    paper-menu {
      transform: translateY(12px);
      visibility: visible;
      position: absolute;
      height: 145px;
      background: #fff;
      box-shadow: 0 8px 10px 1px rgba(0, 0, 0, 0.14),
      0 3px 14px 2px rgba(0, 0, 0, 0.12),
      0 5px 5px -3px rgba(0, 0, 0, 0.4);
      border-radius: 2px;
      transition: transform .2s,visibility .2s;
    }
  </style>
  <template>


    <!--back arrow is hidden if view is not narrow and if it's not in search mode-->
    <div class="horizontal layout">
      <paper-icon-button icon="arrow-back" on-tap="hideSearch" hidden$="{{!searchIsActive}}"></paper-icon-button>
      <paper-icon-button icon="search" on-tap="clickedSearch" hidden$="{{isNarrow}}"></paper-icon-button>
      <div class="layout vertical flex">
        <paper-input no-label-float
                     label="Search"
                     hidden$="{{isNarrow}}"
                     focused$="logConsole"
                     class="flex"
                     placeholder="{{placeholderText}}"
                     value="{{searchFieldValue}}"></paper-input>
        <div id="suggestionPlaceholder" hidden$="{{!enableSearchSuggestions}}">

          <paper-menu      id="searchSuggestions"
                           class="list hidden"
                           autoFocusDisabled="true">
            <iron-selector selected="{{selectedSuggestion}}"
                           selectedAttribute=""
                           id="suggestionSelector">
              <template is="dom-repeat" items="{{suggestions}}">
                <paper-item on-tap="onTapSuggestion">
                  <div class$="{{'truncate' + (recent ? ' recent' : '')}}">{{item.text}}</div>
                </paper-item>
              </template>
            </iron-selector>
          </paper-menu>
        </div>
        </div>
      <paper-icon-button icon="search" on-tap="clickedSearch" hidden$="{{!isNarrow}}"></paper-icon-button>
    </div>
  </template>
  <script>

    Polymer({
      is: 'uqlibrary-search-input',

      properties: {
        /**
         * TODO: description of these properties
         */
        searchIsHidden: Boolean,
        enableSearchSuggestions: {
          type: Boolean,
          value: false
        },
        isNarrow: Boolean,
        suggestions: Array,
        selectedSuggestion: Number,
        searchFieldValue: {
          type: String,
          value: '',
          observer: 'searchFieldValueChanged'
        }

      },

      // Element Lifecycle
      ready: function() {
        // `ready` is called after all elements have been configured, but
        // propagates bottom-up. This element's children are ready, but parents
        // are not.
        //
        // This is the point where you should make modifications to the DOM (when
        // necessary), or kick off any processes the element wants to perform.

        this.searchIsHidden = true;
        console.log(this.enableSearchSuggestions);
        if(this.enableSearchSuggestions) {
          this._initSearchSuggestionsEvents();
        }
      },
      attached: function() {
        console.log(this.enableSearchSuggestions);
        // `attached` fires once the element and its parents have been inserted
        // into a document.
        //
        // This is a good place to perform any work related to your element's
        // visual state or active behavior (measuring sizes, beginning animations,
        // loading resources, etc).
      },
      detached: function() {
        // The analog to `attached`, `detached` fires when the element has been
        // removed from a document.
        //
        // Use this to clean up anything you did in `attached`.
      },

      /**
       * The uqlibrary-search-input-back event is fired
       * when the user taps the back button
       *
       * @event uqlibrary-search-input-back
       */
      hideSearch: function() {
        this.fire('uqlibrary-search-input-back');
        this.searchIsHidden = true;
        this.$.searchInput.focus();
      },
      /**
       * The uqlibrary-search-input-button-clicked event is fired
       * when the user taps the search button, likewise the
       * uqlibrary-search-input-button-clicked-narrow event is fired
       * when the user taps the search button while the viewport is narrow
       *
       * @event uqlibrary-search-input-button-clicked
       * @event uqlibrary-search-input-button-clicked-narrow
       */
      clickedSearch: function() {
        if (this.narrow) {
          if(!this.searchIsHidden) {
            this.search();
          } else {
            this.fire('uqlibrary-search-input-button-clicked-narrow');
            this.searchIsHidden = false;
          }
        } else {
          this.fire('uqlibrary-search-input-button-clicked');
          this.search();
        }
      },


      /**
       * The _initSearchSuggestionsEvents private method
       * is used to instantiate the search suggestions by
       * creating an event listener and adding relevant data
       * to a new array
       *
       */
      _initSearchSuggestionsEvents: function() {
        var that = this;

        document.addEventListener('uqlibrary-search-input-search-suggestions-loaded', function (e) {
          console.log(e);
          var _data = e.detail.data;
          if (_data.constructor === Array) {
            that.suggestions = _data;
            that.selectedSuggestion = -1;
            that.showSuggestions();
          }
        });
      },

      /**
       * The uqlibrary-search-input-search-submitted event is fired
       * when the user submits a search
       *
       * @event uqlibrary-search-input-search-submitted
       */
      search: function() {
        this.fire('uqlibrary-search-input-search-submitted', {searchTerm: this.searchFieldValue});
      },

      searchFieldValueChanged: function (newValue) {
        console.log('search field value changed! ' + this.searchFieldValue);
        if (this.skipValueChangeHandle) {
          this.skipValueChangeHandle = false;
          return;
        }
        this.fire('uqlibrary-search-input-search-value-changed', {value: newValue});
      },

      onSearchKeys: function (ev) {
        if (this.enableSearchSuggestions && ev.detail.key === 'down' && this.selectedSuggestion < (this.suggestions.length - 1)) {
          this.selectedSuggestion++;
        }
        else if (this.enableSearchSuggestions && ev.detail.key === 'up') {
          if (this.selectedSuggestion > 0) {
            this.selectedSuggestion--;
          } else {
            this.selectedSuggestion = -1;
          }
        }
        else if (ev.detail.key === 'enter') {
          if (
            this.enableSearchSuggestions &&
            this.selectedSuggestion >= 0 &&
            this.previousKey &&
            (this.previousKey === 'up' || this.previousKey === 'down')
          ) {
            this.async(function () {
              this.suggestionSearch();
            }, 100);
          } else {
            this.search();
          }
        }
        else if (this.enableSearchSuggestions && ev.detail.key === 'esc') {
          this.selectedSuggestion = -1;
//          this.$.searchSuggestions.opened = false;
//          this.$.filters.opened = false;
        }
        this.previousKey = ev.detail.key;
      },

      onTapSuggestion: function () {
        this.async(function () {
          this.suggestionSearch();
        }, 100);
      },

      suggestionSearch: function () {
        var suggestion = this.suggestions[this.selectedSuggestion];

        this.skipValueChangeHandle = true;
        this.searchFieldValue = suggestion.text;
        this.$.searchSuggestions.toggleClass('hidden');
        this.search();

        if (suggestion.hasOwnProperty('url')) {
          window.location.href = suggestion.url;
        }

      },

      showSuggestions: function () {

        var that = this;

//        this.$.searchSuggestions.toggleClass('hidden');
        this.async(function () {
          if (that.suggestions.length > 0 && !that.searching) {
            that.$.searchSuggestions.toggleClass('hidden');
          }
//          else if (this.$.searchSuggestions.classList.contains('hidden')) {
//            this.$.searchSuggestions.toggleClass('hidden');
//          }
        }, 100);
      }
    });
  </script>
</dom-module>